#!/bin/sh

set -eu

if grep -Fqx "# UNCONFIGURED FSTAB FOR BASE SYSTEM" /etc/fstab; then
  cat /dev/null > /etc/fstab
fi

mkdir -p /export/home

export_line='/home	/export/home	none	rw,bind	0	0'
if ! grep -Fqx "$export_line" /etc/fstab; then
  {
    echo '# Setup for NFS server by /etc/puavo-conf/scripts/setup_nfs_server'
    printf "%s\n" "$export_line"
  } >> /etc/fstab
fi

read puavo_kerberos_realm < /etc/puavo/kerberos/realm

cat <<EOF > /etc/idmapd.conf
[General]

Verbosity = 0
Pipefs-Directory = /run/rpc_pipefs
Domain = ${puavo_kerberos_realm}

[Mapping]

Nobody-User = nobody
Nobody-Group = nogroup
EOF

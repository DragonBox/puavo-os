#!/bin/sh

set -eu

# sleep 300

my_hostname=$(hostname)

if [ -r /etc/puavo/ldap/dn -a -r /etc/puavo/ldap/password ]; then
  prr_args='--user-etc'
else
  prr_args='--user-bootserver'
fi

logmsg() { logger -t puavo-send-sysinfo-to-puavo "$@"; }

while true; do
  if ! sysinfo_json=$(
    dbus-send --system --dest=org.puavo.client.systeminfocollectordaemon \
              --print-reply=literal /systeminfocollector \
              org.puavo.client.systeminfocollector.CollectSysinfo); then
    logmsg -p user.err 'could not get sysinfo from sysinfocollector'
  else
    tmpfile=$(mktemp /tmp/puavo-send-sysinfo-to-puavo.XXXXXX)
    if ! echo "$sysinfo_json" | jq 'del(.network_interfaces)' > "$tmpfile"; then
      logmsg -p user.err 'could not filter out network interfaces info'
    else
      if ! puavo-rest-request "v3/devices/${my_hostname}xx/sysinfo" $prr_args \
                              -- -F "sysinfo=<$tmpfile" >/dev/null; then
        logmsg -p user.err 'sending sysinfo to puavo failed'
      else
        logmsg -p user.info 'sysinfo sent to puavo successfully'
      fi
    fi
    rm -f "$tmpfile"
  fi

  sleep 86400
done

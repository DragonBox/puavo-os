#!/bin/sh

set -eu

EXTRAUSERS_EXPIRED_USERS_PATH='/var/lib/extrausers/expired'

if [ "$(puavo-conf puavo.admin.personally_administered)" = 'true' ]; then
  rm -f "$EXTRAUSERS_EXPIRED_USERS_PATH"
  exit 0
fi

exitstatus=0

logmsg() {
  logger -t puavo-cleanup-old-users "$@" || true
}

get_current_system_uids() {
  # 65534 is "nobody"-user
  {
    getent passwd | awk -F: '$3 >= 10000 { print $3 }'
    find /home -mindepth 1 -maxdepth 1 -printf "%U\n"
  } \
  | awk '$1 >= 10000 && $1 != 65534' \
  | sort -nu
}

get_organisation_uids() {
  if ! response=$(/usr/bin/puavo-rest-request v3/users --user-etc \
                    -- --get --data-urlencode attributes=uid_number); then
    logmsg -p user.err \
           'puavo-rest-request v3/users to get UIDs in organisation failed'
    return 1
  fi

  if ! parsed_response=$(echo "$response" | jq -r '.[] | .uid_number'); then
    logmsg -p user.err 'JSON parsing of organisation uids failed'
    return 1
  fi

  if ! unsorted_organisation_uids=$(
    printf %s "$parsed_response" \
      | awk '
          BEGIN { found_valid_uids = 0 }
          !/^[0-9]+$/ || $0 < 10000 || $0 == 65534 {
            print $0, "is not a valid Puavo uid number" > "/dev/stderr"
            exit(1)
          }
          { print; found_valid_uids = 1 }
          END {
            # Protect against not getting any output...
            # it appears as if all users have been removed
            # from the organisation.
            if (!found_valid_uids) {
              print "no valid uid numbers were found" > "/dev/stderr"
              exit(1)
            }
          }
        '); then
    logmsg -p user.err 'awk parsing of organisation uids failed'
    return 1
  fi

  if ! echo "$unsorted_organisation_uids" | sort -nu; then
    logmsg -p user.err 'sorting and uniqueing of organisation uids failed'
    return 1
  fi
}

if ! organisation_uids=$(get_organisation_uids); then
  logmsg -p user.err 'could not get a list of organisation uids'
  exit 1
fi

current_system_uids=$(get_current_system_uids)

remove_uids_list=''
remove_usernames_list=''

for sys_uid in $current_system_uids; do
  if echo "$organisation_uids" | grep -Fqx "$sys_uid"; then
    # system uid found in organisation uids
    continue
  fi

  remove_uids_list="${remove_uids_list} ${sys_uid}"
done

# XXX 365 days should be configurable
daylimit_for_removals=365

for uid_to_remove in $remove_uids_list; do
  if ! removal_messages=$(LANG=C find /home -maxdepth 1 -mindepth 1 -ctime "+${daylimit_for_removals}" -user "$uid_to_remove" -exec rm -rvf \{} \;); then
    logmsg -p user.err 'an error occurred when removing old home directories'
    exitstatus=1
    continue
  fi

  if [ -n "$removal_messages" ]; then
    logmsg -p user.notice \
           "removed directories of user ${uid_to_remove}:\n${removal_messages}"
  fi

  if ! possible_homedirs="$(find /home -maxdepth 1 -mindepth 1 \
    -user "$uid_to_remove")"; then
      logmsg -p user.err 'error looking up home directories'
      exitstatus=1
      continue
  fi

  if [ -n "$possible_homedirs" ]; then
    logmsg -p user.info \
           "home directories for user ${uid_to_remove} still exist, because they have been used in the last ${daylimit_for_removals} days"
    # if homedir still exists, do not cleanup the user any further
    continue
  fi

  if ! username=$(id -nu "$uid_to_remove") || [ -z "$username" ]; then
    logmsg -p user.err \
           "looking up username for ${uid_to_remove} failed, so not doing further purge of user information"
    exitstatus=1
    continue
  fi

  remove_usernames_list="${remove_usernames_list} ${username}"

  logmsg -p user.info \
         "removing /var/lib/puavo-desktop/users/${username}"
  rm -rf "/var/lib/puavo-desktop/users/${username}" || exitstatus=1

  logmsg -p user.info \
         "removing user ${username} network connections from under /etc/NetworkManager/system-connections"
  {
    find /etc/NetworkManager/system-connections -mindepth 1 -maxdepth 1
      -type f -print0 \
        | xargs -0 --no-run-if-empty awk -v username="$username" '
            BEGIN { FS = "="; ORS = "\0" }
            $1 == "permissions" {
              split($2, userlist, /;/)
              for (i in userlist) {
                if (userlist[i] == ("user:" username ":") {
                  print FILENAME
                }
              }
            }
          ' \
        | xargs -0 rm -f
  } || exitstatus=1
done

if [ -n "$remove_usernames_list" ]; then
  logmsg -p user.notice \
         "putting users '${remove_usernames_list}' to ${EXTRAUSERS_EXPIRED_USERS_PATH} for puavo-login to remove"
  # Update atomically because puavo-login might be checking this out.
  #
  printf %s "$remove_usernames_list" > "${EXTRAUSERS_EXPIRED_USERS_PATH}.tmp"
  mv "${EXTRAUSERS_EXPIRED_USERS_PATH}.tmp" "$EXTRAUSERS_EXPIRED_USERS_PATH"
fi

if [ "$exitstatus" -ne 0 ]; then
  logmsg -p user.err 'there was some errors'
fi

exit $exitstatus

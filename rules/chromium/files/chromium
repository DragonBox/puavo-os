#!/bin/sh

set -eu

manage_preferences() {
  tmpfile="${preferences_file}.tmp"

  if [ -e "$preferences_file" ]; then
    jq "$@" "$preferences_file" > "$tmpfile" || return 1
  else
    jq --null-input "$@" > "$tmpfile" || return 1
  fi

  mv "$tmpfile" "$preferences_file"
}

default_args="--disable-infobars --no-default-browser-check --no-first-run"

preferences_dir=~/.config/chromium/Default
preferences_file="${preferences_dir}/Preferences"

mkdir -p "$preferences_dir"

if [ -n "$HOMEPAGE" ]; then
  manage_preferences --arg homepage "$HOMEPAGE" \
    '.session.startup_urls = [ $homepage ]' || true
fi

exec /usr/bin/chromium.distrib $default_args "$@"

#!/usr/bin/ruby1.9.3
#
# Get device settings from the LDAP-server (Puavo) and generate pxelinux.cfg data for terminal.
# 
# Usage: [sudo] ltspboot-config [PXE GET URL]
#
# eg. sudo ltspboot-config pxelinux.cfg/01-78-e7-d1-d4-0f-5f

$LOAD_PATH.unshift( File.dirname(__FILE__) )

require 'puavo-ldap'

def help
  "Usage: [sudo] ltspboot-config [PXE GET URL]\n" +
  "\t-h, --help\tShow this message\n"
end

option = ARGV[0]

if option == "-h" || option == "--help" || option.nil?
  puts help
  exit
end

if match_option = option.match(/01-(([0-9A-Fa-f]{2}[:-]){5}[0-9A-Fa-f]{2})/)
  client_mac = match_option[1].to_s.gsub('-', ':').downcase
else
  puts "Invalid options\n\n"
  puts help
  exit
end

ltsp_client = PuavoLdap.new.device_by_mac(client_mac)

kernel_version = Array(ltsp_client['puavoDeviceKernelVersion']).first.to_s
kernel_version = "-" + kernel_version if not kernel_version.empty?

kernel_args = Array(ltsp_client['puavoDeviceKernelArguments']).first.to_s
kernel_args = "quiet splash" if kernel_args.empty?

image = Array(ltsp_client['puavoDeviceImage']).first.to_s
image = "ltsp_i386" if image.empty?

bootmode = Array(ltsp_client['puavoDeviceBootMode']).first.to_s
bootmode = "netboot" if bootmode.empty?

device_type = ltsp_client['puavoDeviceType']

header = ""
# Show menu to user if device's boot mode is dualboot
if bootmode == "dualboot"
  header =<<EOF
default menu.c32
menu title Choose a system
prompt 0
timeout 100

label local
  menu label Local OS
  localboot 0
EOF
else
  header =<<EOF
default ltsp-NBD
ontimeout ltsp-NBD

EOF
end

puts <<EOF
#{header}

label ltsp-NBD
  menu label LTSP, using NBD
  menu default
  kernel vmlinuz#{kernel_version}
  append ro initrd=initrd.img#{kernel_version} init=/sbin/init-puavo puavo.type=#{device_type} plymouth:force-splash vt.handoff=7 root=/dev/nbd0 nbdroot=:#{image} #{kernel_args}
  ipappend 2
EOF

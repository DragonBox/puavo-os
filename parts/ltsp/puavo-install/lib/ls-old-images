#!/bin/sh

set -eu

images_dir=$1

images_managed_by_puavo_bootserver_sync_images() {
  # this file is only created by puavo-bootserver-sync-images on bootservers,
  # thus it is rather normal if it is missing
  test -e /var/lib/puavo/images.json || return 0

  # however, syntax errors in images.json are an error we must handle
  if ! _managed_images=$(jq -r '.[] | .[]' /var/lib/puavo/images.json); then
    echo 'could not parse /var/lib/puavo/images.json' >&2
    return 1
  fi

  printf %s "$_managed_images" \
    | grep '\.img$' \
    | sort \
    | uniq
}

lookup_old_images() {
  # errors in find we must handle
  _old_images=$(find "$images_dir" -maxdepth 1 -type f -a \
                  '(' '(' -name '*.img' -o -name '*.img.tmp' ')' \
		  -a '!' -samefile "${images_dir}/ltsp.img" ')')
  printf %s "$_old_images" | sort
}

if [ ! -d "$images_dir" -o ! -e "${images_dir}/ltsp.img" ]; then
  exit 0
fi


managed_image_list=$(images_managed_by_puavo_bootserver_sync_images)
old_image_list=$(lookup_old_images)

IFS='
'
for old_image in $old_image_list; do
  found=false
  for managed_image in $managed_image_list; do
    if [ "$old_image" = "$managed_image" ]; then
      found=true
      break
    fi
  done
  if ! $found; then
    printf "%s\n" "$old_image"
  fi
done

#!/usr/bin/ruby

require 'etc'
require 'highline/import'

def salt
  chars = ([ ('a'..'z'), ('A'..'Z'), (0 .. 9) ].map &:to_a).flatten
  '$6$' + (8.times.map { chars[ rand(chars.size) ] }).to_s
end

password1 = HighLine.ask('Enter password: ')       { |q| q.echo = false }
password2 = HighLine.ask('Enter password again: ') { |q| q.echo = false }

if password1 != password2 then
  STDERR.puts "Passwords did not match"
  exit 1
end

File.open('/var/lib/ltsconfd/term_rootpw', 'w', 0640) do |f|
  f.chown(Etc.getpwnam('root').uid, Etc.getpwnam('ltsconfd').gid)
  f.puts password1.crypt(salt())
end

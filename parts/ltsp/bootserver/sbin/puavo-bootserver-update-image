#!/bin/sh

set -eu

server=$(cat /etc/puavo/image_server 2>/dev/null || true)
user=$USER

while getopts s:u: flag; do
    case $flag in
        s)
            server="${OPTARG}"
            ;;
        u)
            user="${OPTARG}"
            ;;
        ?)
            echo "error: unexpected option '${flag}'" >&2
            exit 1;
            ;;
    esac
done

shift $((OPTIND - 1));

if [ $# -ne 1 ]; then
    echo "error: invalid arguments" >&2
    echo "Usage: $(basename $0) [-s SERVER] [-u USER] IMAGE" >&2
    exit 1
fi

image=$1
remote_dir=/opt/ltsp/images
local_dir=/opt/ltsp/images
image_link="${local_dir}/${image}.img"

flavor=quantal
if [ -L "${image_link}" ]; then
    flavor=$(readlink -e "${image_link}" | xargs -n1 basename | cut -d'-' -f2)
fi

remote_file=$(ssh "${user}@${server}" "ls -1 ${remote_dir}/ltsp-${flavor}-master-*.img | sort -u | tail -n1 | xargs -n1 basename")
local_file=$(ls -1 ${local_dir}/ltsp-${flavor}-master-*.img | sort -u | tail -n1 | xargs -n1 basename)

if [ -n "{server}" -a "${remote_file}" \> "${local_file}" ]; then
    echo "Found newer remote image: ${remote_file}"
    echo -n "Download? [n/Y] "

    read yesno

    if [ "${yesno}" == "y" -o "${yesno}" == "Y" -o "${yesno}" == "" ]; then
        cp "${local_dir}/${local_file}" "${local_dir}/${remote_file}"
        rsync -avz --progress "${user}@${server}:${remote_dir}/${remote_file}" "${local_dir}/${remote_file}"
    fi
fi

ln -sf "${local_dir}/${local_file}" "${image_link}"
ltsp-update-kernels "${image}"

#!/bin/sh

set -e

. puavo-bootserver-installdirs

setup_ds_slave() {
    install -o root -g root -m 644 "$PUAVO_BOOTSERVER_TEMPLATEDIR/etc/default/slapd" /etc/default/slapd
    install -o root -g root -m 755 "$PUAVO_BOOTSERVER_TEMPLATEDIR/etc/init.d/slapd" /etc/init.d
    install -o root -g root -m 644 "$PUAVO_BOOTSERVER_TEMPLATEDIR/etc/default/krb5-kdc" /etc/default
    install -o root -g root -m 755 "$PUAVO_BOOTSERVER_TEMPLATEDIR/etc/init.d/krb5-kdc" /etc/init.d
    install -o root -g root -m 644 "$PUAVO_BOOTSERVER_TEMPLATEDIR/etc/init/puavo-krb5-kdc.conf" /etc/init

    cat <<EOF > /etc/ldap/ldap.conf
BASE            $(cat /etc/puavo/ldap/base)
NETWORK_TIMEOUT 15
SASL_MECH       GSSAPI
TIMEOUT         15
TLS_CACERT      /etc/puavo/certs/rootca.pem
TLS_REQCERT     demand
URI             ldap://$(cat /etc/puavo/hostname).$(cat /etc/puavo/domain)
EOF

    puavo-init-ldap-slave --force
    echo "Run following commands as a root in your LDAP-master:

FQDN=$(cat /etc/puavo/hostname).$(cat /etc/puavo/domain)
REALM=$(cat /etc/puavo/kerberos/realm)
kadmin.local -r \${REALM} -q \"addprinc -randkey ldap/\${FQDN}\"
kadmin.local -r \${REALM} -q \"addprinc -randkey host/\${FQDN}\"
kadmin.local -r \${REALM} -q \"addprinc -randkey IPP/\${FQDN}\"
kadmin.local -r \${REALM} -q \"addprinc -randkey cifs/\${FQDN}\"
kadmin.local -r \${REALM} -q \"addprinc -randkey nfs/\${FQDN}\"

Press ENTER when ready."

    read ready

    wait_for_slapd_sync
    puavo-init-kdc-slave --force
}

setup_cups() {
  apt-get -y install m4

  m4 -D__fqpuavoname__="$(cat /etc/puavo/hostname).$(cat /etc/puavo/domain)" \
    "$PUAVO_BOOTSERVER_TEMPLATEDIR/etc/cups/cupsd.conf" | tee /etc/cups/cupsd.conf > /dev/null
  service cups restart || service cups start
}

setup_nfs() {
  install -o root -g root -m 644 "$PUAVO_BOOTSERVER_TEMPLATEDIR/etc/default/nfs-kernel-server.template" \
    /etc/default/nfs-kernel-server

  install -o root -g root -m 644 "$PUAVO_BOOTSERVER_TEMPLATEDIR/etc/default/nfs-common.template" \
    /etc/default/nfs-common

  cat <<EOF > /etc/exports
/export gss/krb5(rw,fsid=0,async,subtree_check,no_root_squash,crossmnt)
/export/home gss/krb5(rw,async,subtree_check,no_root_squash)
EOF

  cat <<EOF > /etc/idmapd.conf
[General]

Verbosity = 0
Pipefs-Directory = /run/rpc_pipefs
Domain = $(cat /etc/puavo/kerberos/realm)

[Mapping]

Nobody-User = nobody
Nobody-Group = nogroup
EOF

  cat <<EOF >> /etc/fstab
/home /export/home none rw,bind 0 0
EOF

  mkdir -p /export/home

  mount -a
  service nfs-kernel-server restart
  service idmapd restart
}

setup_sssd() {
  install -o root -g root -m 644 "$PUAVO_BOOTSERVER_TEMPLATEDIR/etc/nsswitch.conf"  /etc/nsswitch.conf
  install -o root -g root -m 600 "$PUAVO_BOOTSERVER_TEMPLATEDIR/etc/sssd/sssd.conf" /etc/sssd/sssd.conf

  # XXX may break easily...
  sed -i \
    "s|__puavo_ldap_dn__|$(cat /etc/puavo/ldap/dn)|;
     s|__puavo_kerberos_realm__|$(cat /etc/puavo/kerberos/realm)|;
     s|__puavo_domain__|$(cat /etc/puavo/domain)|;
     s|__puavo_ldap_base__|$(cat /etc/puavo/ldap/base)|;
     s|__puavo_ldap_master__|$(cat /etc/puavo/ldap/master)|;
     s|__puavo_ldap_password__|$(cat /etc/puavo/ldap/password)|;" \
      /etc/sssd/sssd.conf 
  service sssd restart || service sssd start
}

setup_network() {
    echo "Fix your network settings and reboot, otherwise press ENTER to continue."
    read answer
}

setup_root_passwd() {
    echo 'Set root passwd? [y/N]'
    read set_root_passwd
    [ "$set_root_passwd" = "y" ] && su -c passwd
    true
}

setup_nbd_exports() {
    mkdir -p /opt/ltsp/images
    for devimgname in i386 precise testing; do
        ln -sft /opt/ltsp/images $devimgname.img
    done
    puavo-bootserver-generate-nbd-exports
    service nbd-server restart
}

wait_for_slapd_sync() {
  # it's a hack...

  echo "Waiting for slapd to sync all data from ldap master."
  echo "This may take a while."

  _previous_linecount=-1
  _current_linecount=0
  while [ "$_previous_linecount" -ne "$_current_linecount" ]; do
    if [ "$_current_linecount" -gt 0 ]; then
      echo "Still waiting... the magic number is $_current_linecount now."
    fi

    sleep 10
    _previous_linecount=$_current_linecount
    _current_linecount=$(slapcat | wc -l)
  done

  echo "LDAP database in now in sync."
  echo
}

install -m 644 --backup=numbered "$PUAVO_BOOTSERVER_TEMPLATEDIR/etc/pam.d/common-password" /etc/pam.d/common-password
setup_root_passwd
apt-get update
apt-get -y dist-upgrade
setup_network
[ -d /etc/puavo ] || puavo-register
setup_ds_slave
setup_nfs
setup_sssd
setup_cups
puavo-bootserver-setup-pxe
puavo-init-bootserver-ddns
puavo-create-kvm-ltsp-server "$(cat /etc/puavo/hostname)-ltsp1"
cat <<EOF > /etc/puavo/primary_ltsp_server
$(cat /etc/puavo/hostname)-ltsp1
EOF
adduser dhcpd puavo
cat <<EOF > /etc/sudoers.d/puavo-bootserver
dhcpd ALL=(ALL) NOPASSWD: /bin/cat /etc/puavo/ldap/password
EOF
chmod 0440 /etc/sudoers.d/puavo-bootserver
cat <<EOF > /etc/puavo/ldap/slave
$(cat /etc/puavo/hostname).$(cat /etc/puavo/domain)
EOF
setup_nbd_exports

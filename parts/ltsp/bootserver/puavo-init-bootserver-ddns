#!/usr/bin/ruby

require 'fileutils'
require 'highline/import'
require 'tmpdir'

puavo_device_type = ARGV[0]

if (!puavo_device_type)
  if File.exists?("/etc/puavo/hosttype")
    puavo_device_type = File.read('/etc/puavo/hosttype').chomp
  end
end

if puavo_device_type == 'unregistered'
  exit(0)
end

@ldap_master       = File.read('/etc/puavo/ldap/master'    ).chomp
#@ldap_slave        = File.read('/etc/puavo/ldap/slave'     ).chomp
@ldap_base         = File.read('/etc/puavo/ldap/base'      ).chomp
@kerberos_master   = File.read('/etc/puavo/kerberos/master').chomp
@kerberos_realm    = File.read('/etc/puavo/kerberos/realm' ).chomp
#@kerberos_toprealm = File.read('/etc/puavo/kerberos/toprealm' ).chomp
@puavo_hostname    = File.read('/etc/puavo/hostname'       ).chomp
@puavo_domain      = File.read('/etc/puavo/domain'         ).chomp
#@puavo_topdomain   = File.read('/etc/puavo/topdomain'      ).chomp
@arpazone = "10.in-addr.arpa"

def write_config(filename, version=nil, secure=false)
  template_file = filename

  if version
    template_file = "#{filename}-#{version}"
  end

  conf_template = File.read("/usr/share/puavo-ltsp-bootserver/templates#{template_file}")
  conf = ERB.new(conf_template, 0, "%<>")

  perm = secure ? 0600 : 0644

  File.open(filename, "w", perm) do |f|
    f.write conf.result
  end

  File.chmod(perm, filename)
end

`ddns-confgen -a hmac-md5 -q > /etc/bind/nsupdate.key`

`/etc/init.d/bind9 stop`

delete_files = ["/var/lib/bind/puavo_domain.jnl",
                "/var/lib/bind/puavo_domain_reverse.jnl"]

delete_files.each do |file|
  if File.exists?(file)
    puts "Deleting old journal file: #{file}"
    File.delete(file)
  end
end

@ltsp_iface_ip = `ifconfig ltsp0 | grep "inet addr" | awk -F: '{print $2}' | awk '{print$1}'`
@wlan_iface_ip = `ifconfig wlan0 | grep "inet addr" | awk -F: '{print $2}' | awk '{print$1}'`

write_config("/etc/bind/named.conf.local")
write_config("/etc/bind/named.conf.options")
write_config("/var/lib/bind/puavo_domain")
write_config("/var/lib/bind/puavo_domain_reverse")

`chown bind.bind /var/lib/bind/puavo_domain`
`chown bind.bind /var/lib/bind/puavo_domain_reverse`

`chown root:dhcpd /etc/bind/nsupdate.key`
`chmod 0640 /etc/bind/nsupdate.key`


`/etc/init.d/bind9 start`

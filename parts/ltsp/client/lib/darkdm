#!/bin/bash

set -eu

install()
{
    local i

    /usr/sbin/puavo-install || {
        echo 'Error: Installation failed.' >&2
        return 1
    }

    for i in $(seq 5 -1 1); do
        echo -n -e "\rRebooting in ${i}s..."
        sleep 1
    done
    echo -e "\rRebooting now!    "

    reboot
}

print_help()
{
    echo "Commands:"
    echo "  help     -  show this help"
    echo "  install  -  install Puavo OS to this device"
    echo "  reboot   -  reboot the system immediately"
}

main()
{
    local command
    local tty_dev
    local tty_n

    trap '' SIGINT

    tty_dev=$(tty)
    tty_n=$(echo "${tty_dev}" | sed -r -n 's|/dev/tty||p')

    if [ -n "${tty_n}" ]; then
	chvt "${tty_n}"
    fi

    echo 'Welcome to the Dark side!' | /usr/games/cowsay -b

    print_help

    while true; do
	read -e -p "> " command || {
	    echo
	}

	case "${command}" in
            'install')
		install
		;;
	    'reboot')
		reboot
		;;
	    'help')
		print_help
		;;
	    *)
		echo "Error: Invalid command '${command}'. Try 'help'." >&2
		;;
	esac
    done
}

main

#!/bin/sh

set -eu

usage() {
  cat <<EOF
Usage:
  $(basename $0) [--pass-credentials|--user-bootserver|--user-etc|--user-krb]
                 [--post]
                 [--send-device-credentials]
                 [--send-hostname]
                 urlpath
EOF
}

check_mode() {
  if [ -n "$1" ]; then
    usage >&2
    exit 1
  fi
}

make_request() {
  url=$1; shift

  # use curl instead of puavo-rest-client for efficiency reasons

  # no timeouts here, it is the caller's responsibility to decide on that
  curl --cacert /etc/puavo/certs/rootca.pem       \
       --fail                                     \
       --show-error                               \
       --silent                                   \
       "$@"                                       \
       "$url"
}

curl_args=''
mode=''
password=false
puavo_resolve_args=''

if ! args=$(getopt -n "$0" -o + \
  -l 'pass-credentials,post,user-bootserver,send-device-credentials,send-hostname,user-etc,user-krb,use-writable' \
    -- "$@"); then
      usage >&2
      exit 1
fi

eval "set -- $args"
while [ $# -ne 0 ]; do
  case "$1" in
    --pass-credentials)
      check_mode "$mode"

      password="$(cat 2>/dev/null || true)"
      if [ -z "$password" ]; then
        echo 'Could not read password from stdin' >&2
        exit 1
      fi
      username="${USER:-}"
      if [ -z "$username" ]; then
        echo 'Could not find username from USER environment variable' >&2
        exit 1
      fi

      mode='pass-credentials'
      shift
      ;;

    --post)
      curl_args="$curl_args -X POST"
      shift
      ;;

    --send-device-credentials)
      if [ ! -r /etc/puavo/ldap/dn ]; then
        echo 'Can not read device dn from /etc/puavo/ldap/dn' >&2
        exit 1
      fi
      if [ ! -r /etc/puavo/ldap/password ]; then
        echo 'Can not read device password from /etc/puavo/ldap/password' >&2
        exit 1
      fi
      curl_args="$curl_args --form device_dn=</etc/puavo/ldap/dn --form device_password=</etc/puavo/ldap/password"
      shift
      ;;

    --send-hostname)
      if [ ! -r /etc/puavo/hostname ]; then
        echo 'Can not read puavo hostname from /etc/puavo/hostname' >&2
        exit 1
      fi
      curl_args="$curl_args --form hostname=</etc/puavo/hostname"
      shift
      ;;

    --user-bootserver) check_mode "$mode"; mode='bootserver'; shift ;;
    --user-etc)        check_mode "$mode"; mode='etc'       ; shift ;;
    --user-krb)        check_mode "$mode"; mode='krb'       ; shift ;;

    --use-writable)
      puavo_resolve_args='--writable'
      shift
      ;;

    --) shift; break;;
    *) usage >&2; exit 1 ;;
  esac
done

api_server="$(/usr/sbin/puavo-resolve-api-server $puavo_resolve_args)" || true
if [ -z "$api_server" ]; then
  echo 'Could not resolve Puavo API server' >&2
  exit 1
fi

urlpath=${1:-}

if [ -z "$urlpath" ]; then
  usage >&2
  exit 1
fi

url="${api_server}/${urlpath}"

case "$mode" in
  '')
    make_request "$url" $curl_args
    ;;

  bootserver)
    make_request "$url" $curl_args \
      --header 'Authorization: Bootserver'
    ;;

  etc)
    device_dn="$(cat /etc/puavo/ldap/dn 2>/dev/null)" || true
    if [ -z "$device_dn" ]; then
      echo 'Could not determine device dn for this host' >&2
      exit 1
    fi

    device_password="$(cat /etc/puavo/ldap/password 2>/dev/null)" || true
    if [ -z "$device_password" ]; then
      echo 'Could not determine device password for this host' >&2
      exit 1
    fi

    echo "--user ${device_dn}:${device_password}" \
      | make_request "$url" $curl_args --config -
    ;;

  krb)
    make_request "$url"              \
                 $curl_args          \
                 --delegation always \
                 --negotiate         \
                 --user :
    ;;

  pass-credentials)
    echo -n "$password" \
      | make_request "$url" $curl_args         \
          --form-string "username=${username}" \
          --form "password=<-"
    ;;

  *)
    echo "$(basename $0) internal error" >&2
    exit 1
    ;;
esac

exit 0

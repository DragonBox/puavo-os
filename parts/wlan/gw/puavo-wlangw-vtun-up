#!/bin/sh

set -eu

# XXX code duplication with setup_bootserver_shorewall_conf and setup_dns
get_dhcp_interfaces() {
  all_interfaces=$(awk '$1 == "iface" { print $2 }' /etc/network/interfaces \
                                                    /etc/network/interfaces.d/*)

  puavo_dhcpd_interfaces=$(puavo-conf puavo.networking.ddns.dhcpd_interfaces)
  for if_filter in $(echo "$puavo_dhcpd_interfaces" | tr , ' '); do
    for interf in $all_interfaces; do
      case "$interf" in
        $if_filter)
          echo "$interf"
          ;;
      esac
    done
  done
}

ifconfig $1 up
brctl addif $2 $1

# First make sure that there are no tc rules
tc qdisc del root dev $1

tc qdisc add dev $1 root handle 1: htb default 10
# Limit traffic for a single tunnel to 50Mbps
tc class add dev $1 parent 1: classid 1:1 htb rate 50mbit burst 15k

# Give 45Mbps to normal traffic
tc class add dev $1 parent 1:1 classid 1:10 htb rate 45mbit burst 15k

# Give 15Mbps to image sync traffic
tc class add dev $1 parent 1:1 classid 1:20 htb rate 15mbit burst 15k

# Image sync traffic originates from bootserver's port 872 only
for dhcp_iface in $(get_dhcp_interfaces); do
  dhcp_iface_ip=$(ifdata -pa "$dhcp_iface")
  tc filter add dev $1 parent 1: protocol ip prio 1 u32 \
     match ip src "${dhcp_iface_ip}/32"                  \
     match ip sport 872 0xffff flowid 1:20
done

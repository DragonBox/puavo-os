#!/usr/bin/ruby2.0

require './lib/puavo/gems'
require 'optparse'
require 'http'
require './lib/puavo/etc'
require './lib/puavo/image_client'

options = {}
parser = OptionParser.new do |opts|
  opts.banner = "Usage: puavo-download-image <url>"

  opts.on("--output-file FILE", "Output file") do |file|
    options[:file] = file
  end

  opts.on("--download-url URL", "Download url") do |url|
    options[:url] = url
  end

  opts.on("--sha256 SHA256", "Hashing String (sha256)") do |sha256|
    options[:sha256] = sha256
  end

  opts.on_tail("-h", "--help", "Show this message") do
    STDERR.puts opts
    Process.exit
  end
end

parser.parse!

if options[:file].nil?
  puts "Missing argument: --output-file\n\n"
  puts parser.help
  Process.exit(1)
end

if options[:url].nil?
  puts "Missing argument: --download-url\n\n"
  puts parser.help
  Process.exit(1)
end


begin
  PuavoImageClient.download( :sha256 => options[:sha256],
                             :download_url => options[:url],
                             :output_file => options[:file] )
rescue PuavoImageClient::SHA256MismatchError => error
  puts error.to_s
  Process.exit(1)
rescue PuavoImageClient::OutputFileError => error
  puts error.to_s
  Process.exit(1)
end

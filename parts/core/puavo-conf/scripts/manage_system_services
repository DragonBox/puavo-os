#!/bin/sh

set -eu

services='
  avahi-daemon
  fluentd
  incron
  isc-dhcp-server
  krb5-kdc
  ModemManager
  nbd-server
  NetworkManager
  nfs-server
  nmbd
  nscd
  nslcd
  puavo-darkdm
  puavo-rest
  puavo-tftpd
  puavo-vpn-client-dnsmasq
  puavo-vpn-client-openvpn
  redis-server
  rpc-gssd
  sharedir-manager
  shorewall
  slapd
  smbd
  tlp
'

status=0

# XXX look if this is slow and could be optimized (skipping systemctl-tool?)

for service in ${services}; do
  if ! enabled=$(puavo-conf "puavo.service.${service}.enabled"); then
    echo "No puavo-conf setting for puavo.service.${service}.enabled" >&2
    status=1
    continue
  fi

  # As an exception, do not run puavo-vpn-client-dnsmasq on netboot devices,
  # because that will mess up dns configuration (XXX perhaps we need a
  # a special profile for laptops which are booted from network, that override
  # otherwise normal laptop behaviour).
  if [ -e /run/puavo/nbd-server ]; then
    if [ "$service" = 'puavo-vpn-client-dnsmasq' ]; then
      enabled=false
    fi
  fi

  if [ "${enabled}" = 'true' ]; then
    if ! systemctl enable "${service}"; then
      echo "Could not enable ${service}" >&2
      status=1
    fi
  else
    if ! systemctl disable "${service}"; then
      echo "Could not disable ${service}" >&2
      status=1
    fi
  fi
done

exit $status

#!/bin/sh

set -eu

services='
  avahi-daemon
  fluentd
  incron
  isc-dhcp-server
  krb5-kdc
  ModemManager
  nbd-server
  NetworkManager
  nfs-server
  nscd
  nslcd
  puavo-darkdm
  puavo-rest
  puavo-tftpd
  puavo-vpn-client-dnsmasq
  puavo-vpn-client-openvpn
  redis-server
  rpc-gssd
  shorewall
  slapd
  tlp
'

status=0

target_wants_dir='/etc/systemd/system/multi-user.target.wants'

for service in ${services}; do
  if ! enabled=$(puavo-conf "puavo.service.${service}.enabled"); then
    echo "No puavo-conf variable for service '${service}' status" >&2
    status=1
    continue
  fi

  # As an exception, do not run puavo-vpn-client-dnsmasq on netboot devices,
  # because that will mess up dns configuration (XXX perhaps we need a
  # a special profile for laptops which are booted from network, that override
  # otherwise normal laptop behaviour).
  if [ -e /run/puavo/nbd-server ]; then
    if [ "$service" = 'puavo-vpn-client-dnsmasq' ]; then
      enabled=false
    fi
  fi

  if [ "${enabled}" != 'true' ]; then
    if ! rm -f "${target_wants_dir}/${service}.service"; then
      echo "Could not disable service '${service}'" >&2
      status=1
    fi
    continue
  fi

  if [ -e "/lib/systemd/system/${service}.service" ]; then
    service_target="/lib/systemd/system/${service}.service"
  elif [ -e "/etc/systemd/system/${service}.service" ]; then
    service_target="/etc/systemd/system/${service}.service"
  else
    echo "Could not find service '${service}' to enable" >&2
    status=1
    continue
  fi

  if ! ln -fns "$service_target" "${target_wants_dir}/${service}.service"; then
    echo "Could not disable service '${service}'" >&2
    status=1
  fi
done

exit $status

#!/bin/sh

set -eu

# Mount Puavo partitions from local hard drive and use files created by
# puavo-register script.  Checks if LVM partitions /dev/mapper/puavo-home,
# /dev/mapper/puavo-state and /dev/mapper/puavo-tmp and mounts those as
# /home, /state or /tmp correspondingly.
#
# Setup some cups files under /state as well.

read puavo_hosttype < /etc/puavo/hosttype

puavo_link_to_state() {
  local dir

  dir=$1
  test -d "$dir" || return 1

  # Before linking the directory, make sure that the /state partition has
  # the same directory structure as the image so that applications do
  # not freak out because something was be missing. The original directory
  # is renamed to $dir.rofs before replacing the directory with a
  # symbolic link to the /state partition.
  find "$dir" -type d -print0 | cpio -0dpm --quiet /state || return 1
  mv -T "$dir" "${dir}.rofs" 2>/dev/null || true
  ln -fns "/state${dir}" "$dir"
}

puavo_mount_partition() {
  local puavo_partition puavo_mntpoint

  puavo_partition=$1
  puavo_mntpoint=$2

  if ! [ -b "/dev/mapper/${puavo_partition}" ]; then
    return 1
  fi

  mkdir -p "$puavo_mntpoint"

  rotational_value=$(cat /sys/block/sda/queue/rotational 2>/dev/null || true)
  if [ "$rotational_value" = '0' ]; then
    mount_opts='-o discard,noatime'
  else
    mount_opts='-o noatime'
  fi

  mount $mount_opts "/dev/mapper/${puavo_partition}" "$puavo_mntpoint"
}

# CUPS always writes its configuration files as new files and then
# renames the new file to the old name. This breaks the /state linking
# if we just link /etc/cups/printers.conf to /state. To overcome
# this we always copy cups files from the image to the /state partition
# when booting. Locally configured printers should stay configured
# this way and PPDs are placed under /state/etc/cups/ppd.
puavo_setup_cups_dir() {
  find /etc/cups/ -type d -print0 | cpio -0dpm --quiet /state || return 1

  cp -a -t /state/etc/cups/          \
           /etc/cups/cupsd.conf      \
           /etc/cups/cups-files.conf \
           /etc/cups/raw.convs       \
           /etc/cups/raw.types       \
           /etc/cups/snmp.conf       \
    || return 1

  mv -T "/etc/cups" "/etc/cups.rofs" 2>/dev/null || true
  ln -fns /state/etc/cups /etc/cups || return 1

  cups_status=0

  for dir in zjs lava oak hp qpdl slx hiperc; do
    if [ ! -d "/usr/share/foo2${dir}/icm" ]; then
      {
        mkdir -p "/usr/share/foo2${dir}/icm" \
          && puavo_link_to_state "/usr/share/foo2${dir}/icm"
      } || cups_status=1
    fi
  done

  return $cups_status
}

if [ "$puavo_hosttype" = 'diskinstaller' ]; then
  vgchange -a y puavoinstaller
else
  vgchange -a y puavo
fi

status=0

if [ "$puavo_hosttype" = 'diskinstaller' ]; then
  puavo_mount_partition puavoinstaller-installimages /installimages || status=1
fi

if [ "$puavo_hosttype" = 'laptop' ]; then
  puavo_mount_partition puavo-home /home || status=1
fi

if [ "$puavo_hosttype" = 'laptop' \
  -o "$puavo_hosttype" = 'wirelessaccesspoint' ]; then
    if ! puavo_mount_partition puavo-state /state; then
      status=1
    else
      # must fix in case puavo gid has changed...
      chgrp puavo /state/etc/puavo/ldap/password || status=1
      cp -aT /state/etc/puavo /etc/puavo         || status=1

      if [ "$puavo_hosttype" = 'laptop' ]; then
        statedirlist='
          /etc/NetworkManager/system-connections
          /var/crash
          /var/lib/extrausers
          /var/lib/logrotate
          /var/lib/puavo-desktop
          /var/lib/sss
          /var/log
          /var/spool/anacron
        '
      else
        statedirlist='
          /var/lib/logrotate
          /var/log
          /var/spool/anacron
        '
      fi

      for statedir in $statedirlist; do
        puavo_link_to_state "$statedir" || status=1
      done

      if [ "$puavo_hosttype" = 'laptop' ]; then
        puavo_setup_cups_dir || status=1
      fi
    fi
fi

if [ -b /dev/mapper/puavo-tmp ]; then
  { puavo_mount_partition puavo-tmp /tmp && chmod 1777 /tmp; } || status=1
fi

exit $status

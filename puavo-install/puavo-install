#!/bin/sh

set -e

puavo-register --accepted-devicetypes fatclient,laptop,ltspserver,thinclient

hosttype="$(cat /etc/puavo/hosttype)"

case "$hosttype" in
  laptop)
    puavo-setup-filesystems

    mkdir -p /state/etc
    cp -aT /etc/puavo /state/etc/puavo

    # install from nbd, the ltsp image must contain its name in this path
    ltspimage_name=$(cat /etc/ltsp/this_ltspimage_name)

    puavo-install-ltspimages "$ltspimage_name"
    puavo-install-grub

    sync
    umount /state /images /home
    ;;
  ltspserver)
    puavo-setup-filesystems
    mkdir -p /state/etc
    cp -a /etc/puavo /state/etc

    sync
    umount /state
    ;;
esac

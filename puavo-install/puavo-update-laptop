#!/bin/sh

set -eu

hosttype=$(cat /etc/puavo/hosttype)

if [ "$hosttype" != "laptop" ]; then
  echo 'This script should be run only for laptops!' > /dev/stderr
  exit 1
fi

puavo_rest_request() {
  urlpath=$1

  puavo_rest_server=$(puavo-resolve-api-server)
  curl --cacert /etc/puavo/certs/rootca.pem \
       --max-time 60 \
       --silent \
       "${puavo_rest_server}/${urlpath}"
}

puavo_rest_request_and_replace() {
  urlpath=$1
  filepath=$2

  tmp_filepath="${filepath}.tmp"
  install -o root -g root -m 600 /dev/null "$tmp_filepath"
  
  puavo_rest_request "$urlpath" > "$tmp_filepath"
  replace_if_changed "$filepath"  "$tmp_filepath"
}

replace_if_changed() {
  dest=$1
  src=$2

  if cmp "$src" "$dest" >/dev/null 2>&1; then
    rm -f "$src"
  else
    mv "$src" "$dest"
  fi
}

# Update several (different) things.  Even if one thing cannot be updated,
# try to update others (order should not matter here, but do this sequentially
# anyway).

# update lts.conf
{
  install -o root -g root -m 600 /dev/null /state/etc/lts.conf.tmp
  puavo-lts > /state/etc/lts.conf.tmp
  replace_if_changed /state/etc/lts.conf /state/etc/lts.conf.tmp
} || true

# update device.json
{
  puavo_rest_request_and_replace "v3/devices/$(hostname)" \
				 /state/etc/puavo/device.json
} || true

# update external files (under /state/external_files)
{
  puavo-sync-external-files
  puavo-handle-external-files-actions
} || true

# update wlan configurations
{
  puavo_rest_request_and_replace "v3/devices/$(hostname)/wlan_networks" \
				 /state/etc/puavo/wlan.json
  puavo-update-nm-configurations
} || true

# update the ltsp image
{
  # XXX should we use ruby or should we use shell?  or is this okay?
  get_imagename_from_puavo() {
    cat <<'EOF' | ruby1.9.1
require 'puavo'

puavo = Puavo::Client::Base.new(PUAVO_ETC.domain,
                                PUAVO_ETC.ldap_dn,
                                PUAVO_ETC.ldap_password)
device = puavo.devices.find_by_hostname(PUAVO_ETC.hostname)

if device.device_image then
  puts "#{ device.device_image }.img"
else
  exit 1
end
EOF
  }

  next_imagename=$(get_imagename_from_puavo)
  if [ -n "$next_imagename" ]; then
    puavo-install-and-update-ltspimages --rate-limit 50k "$next_imagename"
  fi
} || true

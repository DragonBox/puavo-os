#!/bin/sh

set -e

do_sighup=false

handle_imagefiles() {
  while read filename; do
    image=$(echo "$filename" | sed s'/\(.*\)\.img/\1/')

    conf=/etc/nbd-server/conf.d/${image}.conf
    tmpconf=$conf.tmp

    cat <<EOF > $tmpconf
[${image}]
    exportname = /opt/ltsp/images/${filename}
    readonly = true
EOF

    if cmp $conf $tmpconf 2>/dev/null; then
      rm -f $tmpconf
    else
      mv $tmpconf $conf
      do_sighup=true
    fi
  done
}

find /opt/ltsp/images \
  -maxdepth 1 -name '*.img' '(' -type f -or -type l ')' -printf '%f\n' \
    | handle_imagefiles

if $do_sighup; then
  pkill -HUP -x nbd-server
fi

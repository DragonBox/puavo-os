#!/usr/bin/ruby1.9.3

# Samba configuration script to connect samba3 to Puavo LDAP running
# on localhost. Samba is configured with kerberos support for the
# local puavo kerberos realm.

require "rubygems"
require "erb"
require "puavo"
require "puavo/ldap"
require "puavo/etc"
require "puavo/template"

template = Puavo::Template.new("/usr/share/puavo-ltsp-bootserver")

puavoldap = Puavo::Ldap.new
organisation = Puavo::Client::Base.new_by_ldap_entry( puavoldap.organisation )
@samba_domain = organisation.samba_domain_name

# Stop nmbd and smbd before reconfiguring. In some cases they can
# be stuck so badly that only kill -9 works.

`service nmbd stop`
`service smbd stop`
sleep 5
`pkill -9 -x '(nmbd|smbd)'`

template.write("/etc/samba/smb.conf")

`smbpasswd -w #{PUAVO_ETC.ldap_password}`

`service nmbd start`
`service smbd start`

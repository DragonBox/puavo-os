#!/usr/bin/ruby 
#
# Copyright 2013 Opinsys Oy
#
# Helper script to update DNS entries needed by AirPrint to print to CUPS
# printers.

require 'yaml'
require 'dnsruby'
include Dnsruby

config = Hash.new

@puavo_domain      = File.read('/etc/puavo/domain'         ).chomp

if File.exists?("/etc/dhcp/ddns-keys/nsupdate.key")
  tmp = File.read("/etc/dhcp/ddns-keys/nsupdate.key")
  if /key "(.*?)"/.match(tmp)
    config["key_name"] = $1
  end

  if /secret "(.*?)"/.match(tmp)
    config["key"] = $1
  end
end

config["servers"] = ["127.0.0.1:553"]
config["domain"] = @puavo_domain

if File.exists?("/etc/puavo/nameserver.yml")
  config_file = YAML.load(File.read("/etc/puavo/nameserver.yml"))
  config.merge(config_file)
end

config["servers"].each do |url|
  port = 53
  server = url

  if /(.*):(\d+)/.match(url)
    server = $1
    port = $2
  end

  resolver = Dnsruby::Resolver.new({:nameserver => server})
  resolver.port=(port)

  update = Dnsruby::Update.new(config["domain"])

  resolver.tsig=config["key_name"],config["key"]

  update.delete("_universal._sub._ipp._tcp.#{config["domain"]}")

  `lpstat -a`.split('\n').each do |line|
    if /^(.*?) /.match(line)
      update.add("_universal._sub._ipp._tcp.#{config["domain"]}", 'PTR', 60, "#{$1}._ipp._tcp.#{config["domain"]}.")
      update.add("#{$1}._ipp._tcp.#{config["domain"]}", 'TXT', 60, [ "txtvers=1", "qtotal=1", "Transparent=T", "URF=DM3", "rp=printers/SAMSUNG-CLP-550", "note=Samsung CLP 550", "product=(GPL Ghostscript)", "printer-state=3", "printer-type=0x803014", "pdl=application/octet-stream,application/pdf,application/postscript,image/gif,image/jpeg,image/png,image/tiff,image/urf,text/html,text/plain,application/vnd.cups-banner,application/vnd.cups-pdf,application/vnd.cups-postscript,application/vnd.cups-raw" ])
    end
  end

  begin
    reply = resolver.send_message(update)
  rescue Exception => e
    puts "Update failed: #{e.inspect}"
  end
end

#!/bin/sh

set -eu

unpack_tar_from_github() {
  wget -O - "$1" | tar -zx
}

openboard_version=1.3.6
openboard_dir="openboard-${openboard_version}"

openboard_commit=8015d69a6fecc3e73116e52012ce24691f2d9a74
importer_commit=47927bda021b4f7f1540b794825fb0d601875e79
thirdparty_commit=925f2d1949ef159c1efbe1e0a7fe23202de1d3a3

mkdir -p "$openboard_dir"
cd "$openboard_dir"

unpack_tar_from_github "https://github.com/puavo-org/OpenBoard/archive/${openboard_commit}.tar.gz"
mv "OpenBoard-${openboard_commit}" OpenBoard

unpack_tar_from_github "https://github.com/OpenBoard-org/OpenBoard-Importer/archive/${importer_commit}.tar.gz"
mv "OpenBoard-Importer-${importer_commit}" OpenBoard-Importer

unpack_tar_from_github "https://github.com/OpenBoard-org/OpenBoard-ThirdParty/archive/${thirdparty_commit}.tar.gz"
mv "OpenBoard-ThirdParty-${thirdparty_commit}" OpenBoard-ThirdParty

cat <<'EOF' > Makefile
.PHONY: all
all:
	(cd OpenBoard-ThirdParty/freetype \
	  && qmake freetype.pro -spec linux-g++ \
	  && make)
	(cd OpenBoard-ThirdParty/quazip \
	  && qmake quazip.pro -spec linux-g++ \
	  && make)
	(cd OpenBoard-ThirdParty/xpdf/xpdf-3.04 \
	  && ./configure --with-freetype2-library="../../freetype/lib/linux" \
	       --with-freetype2-includes="../../freetype/freetype-2.6.1/include")
	(cd OpenBoard-ThirdParty/xpdf \
	  && qmake xpdf.pro -spec linux-g++ \
	  && make)
	(cd OpenBoard && ./release_scripts/linux/build.sh)

.PHONY: installdirs
installdirs:
	mkdir -p $(DESTDIR)/opt/openboard
	mkdir -p $(DESTDIR)/opt/openboard/etc
	mkdir -p $(DESTDIR)/opt/openboard/i18n
	mkdir -p $(DESTDIR)/opt/openboard/importer
	mkdir -p $(DESTDIR)/usr/share/applications

.PHONY: install
install: installdirs
	cp -pR OpenBoard/build/linux/release/product/* $(DESTDIR)/opt/openboard/
	cp -pR OpenBoard/resources/customizations $(DESTDIR)/opt/openboard/
	cp -p OpenBoard/resources/images/OpenBoard.png \
	      $(DESTDIR)/opt/openboard/
	cp -p OpenBoard/resources/linux/openboard-ubz.xml \
	      $(DESTDIR)/opt/openboard/etc/
	cp -p openboard.desktop $(DESTDIR)/usr/share/applications/
	cp -p OpenBoard-Importer/OpenBoardImporter \
	      $(DESTDIR)/opt/openboard/importer/
EOF

cat <<'EOF' > openboard.desktop
[Desktop Entry]
Encoding=UTF-8
Name=OpenBoard
Comment=OpenBoard, an interactive white board application
Exec=openboard %f
Icon=/opt/openboard/OpenBoard.png
StartupNotify=true
Terminal=false
Type=Application
MimeType=application/ubz
Categories=Education
EOF

(
  cd ..
  tar -zcf "../openboard_${openboard_version}.orig.tar.gz" "$openboard_dir"
  mv "$openboard_dir"/* .
  rmdir "$openboard_dir"
)

#!/usr/bin/ruby

require 'fileutils'
require 'highline/import'
require 'tmpdir'

puavo_device_type = ARGV[0]

if (!puavo_device_type)
  if File.exists?("/etc/puavo/hosttype")
    puavo_device_type = File.read('/etc/puavo/hosttype').chomp
  end
end

if puavo_device_type == 'unregistered'
  exit(0)
end

@ldap_master       = File.read('/etc/puavo/ldap/master'    ).chomp
@ldap_base         = File.read('/etc/puavo/ldap/base'      ).chomp
@kerberos_master   = File.read('/etc/puavo/kerberos/master').chomp
@kerberos_realm    = File.read('/etc/puavo/kerberos/realm' ).chomp
#@kerberos_toprealm = File.read('/etc/puavo/kerberos/toprealm' ).chomp
@puavo_hostname    = File.read('/etc/puavo/hostname'       ).chomp
@puavo_domain      = File.read('/etc/puavo/domain'         ).chomp
#@puavo_topdomain   = File.read('/etc/puavo/topdomain'      ).chomp

def write_config(filename, version=nil, secure=false)
  template_file = filename

  if version
    template_file = "#{filename}-#{version}"
  end

  conf_template = File.read("/usr/share/puavo-ltsp-client/templates#{template_file}")
  conf = ERB.new(conf_template, 0, "%<>")

  perm = secure ? 0600 : 0644

  File.open(filename, "w", perm) do |f|
    f.write conf.result
  end

  File.chmod(perm, filename)
end

case puavo_device_type
  when "thinclient"
    @ldap_slave = File.read('/etc/puavo/ldap/slave').chomp

    write_config("/etc/nsswitch.conf", "extrausers")
    write_config("/etc/pam.d/lightdm", "thinclient")
    write_config("/etc/ldap/ldap.conf")
    write_config("/etc/krb5.conf")
    write_config("/etc/idmapd.conf")
    write_config("/etc/default/nfs-common")
    write_config("/etc/init/gssd.conf", "userprincipal")
  when "fatclient"
    @ldap_slave = File.read('/etc/puavo/ldap/slave').chomp

    write_config("/etc/nsswitch.conf", "extrausers")
    write_config("/etc/pam.d/lightdm", "fatclient")
    write_config("/etc/ldap/ldap.conf")
    write_config("/etc/krb5.conf")
    write_config("/etc/idmapd.conf")
    write_config("/etc/default/nfs-common")
    write_config("/etc/init/gssd.conf", "userprincipal")

    # FIXME: Hack to get gnome fallback session
    `cp /usr/share/xsessions/gnome-fallback.desktop /usr/share/ltsp-lightdm/xsessions/ltsp-session.desktop`
  when "ltspserver"
    @ldap_slave = File.read('/etc/puavo/ldap/slave').chomp

    write_config("/etc/nsswitch.conf", "sss")
    write_config("/etc/pam.d/ltspsshd")
    write_config("/etc/ldap/ldap.conf")
    write_config("/etc/krb5.conf")
    write_config("/etc/idmapd.conf")
    write_config("/etc/default/nfs-common")
    write_config("/etc/ssh/sshd_config")
    write_config("/etc/ssh/ltspsshd_config")

    @ldap_binddn       = File.read('/etc/puavo/ldap/dn'        ).chomp
    @ldap_bindpw       = File.read('/etc/puavo/ldap/password'  ).chomp
    write_config("/etc/sssd/sssd.conf", nil, true)

    `service sssd restart || service sssd start`
    `service ltspssh restart || service ltspssh start`
    `service gssd restart || service gssd start`
    `service idmapd restart || service idmapd start`

    # http://askubuntu.com/questions/117127/flash-video-appears-blue
    # FIXME - do this in ruby instead of perl
    `perl -pi -e 's/libvdpau/lixvdpau/g' /usr/lib/adobe-flashplugin/libflashplayer.so`
  when "laptop"
    write_config("/etc/nsswitch.conf", "sss")
    write_config("/etc/krb5.conf")
    write_config("/etc/idmapd.conf")
    write_config("/etc/pam.d/lightdm", "laptop")

    # FIXME: Hack to get gnome fallback session
    `cp /usr/share/xsessions/gnome-fallback.desktop /usr/share/ltsp-lightdm/xsessions/ltsp-session.desktop`

    @ldap_binddn       = File.read('/etc/puavo/ldap/dn'        ).chomp
    @ldap_bindpw       = File.read('/etc/puavo/ldap/password'  ).chomp
    write_config("/etc/sssd/sssd.conf", nil, true)
end

`kill -HUP 1`

exit(0)

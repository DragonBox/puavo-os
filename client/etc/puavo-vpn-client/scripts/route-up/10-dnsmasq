#!/bin/bash

# http://twobit.us/blog/2010/02/dnsmasq-and-racoon-vpn/
function inet_aton () {
    local count=3
    local int=0
    for num in $(echo $1 | sed -e 's/\./ /g'); do
        let "int+=$num*256**$count"
        let "count-=1"
    done
    echo $int
}

LDAP_MASTER=$(cat /etc/puavo/ldap/master)
LDAP_SLAVE=$(cat /etc/puavo/ldap/slave)
KERBEROS_MASTER=$(cat /etc/puavo/kerberos/master)

if [ -n "$LDAP_MASTER" ]; then
  TMP_LDAP_MASTER="string:${LDAP_MASTER}"
fi

if [ -n "$LDAP_SLAVE" ]; then
  TMP_LDAP_SLAVE="string:${LDAP_SLAVE}"
fi

if [ -n "$KERBEROS_MASTER" ]; then
  TMP_KERBEROS_MASTER="string:${KERBEROS_MASTER}"
fi

echo dbus-send --system --dest=org.puavo.VPN.dnsmasq \
  /uk/org/thekelleys/dnsmasq \
  uk.org.thekelleys.SetServers \
  uint32:$(inet_aton ${route_vpn_gateway}) \
  "${TMP_LDAP_MASTER}" \
  "${TMP_LDAP_SLAVE}" \
  "${TMP_KERBEROS_MASTER}" > /tmp/jepukepu

dbus-send --system --dest=org.puavo.VPN.dnsmasq \
  /uk/org/thekelleys/dnsmasq \
  uk.org.thekelleys.SetServers \
  uint32:$(inet_aton ${route_vpn_gateway}) \
  "${TMP_LDAP_MASTER}" \
  "${TMP_LDAP_SLAVE}" \
  "${TMP_KERBEROS_MASTER}"

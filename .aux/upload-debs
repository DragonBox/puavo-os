#!/bin/sh

set -eu

debsdir=${1:-}
pkgregex=${2:-.*}
archive_server=${3:-}
archive_login=${4:-$USER}
archive_dir=${5:-}
target_codename=${6:-}

usage() {
  echo "Usage: $(basename $0) debsdir archive_server archive_dir"
}

if [ -z "$debsdir" ]; then
  usage >&2
  echo '  debsdir is not set' >&2
  exit 1
fi

if [ -z "$archive_server" ]; then
  usage >&2
  echo '  archive_server is not set' >&2
  exit 1
fi

if [ -z "$archive_dir" ]; then
  usage >&2
  echo '  archive_dir is not set' >&2
  exit 1
fi

remote_script() {
  # header
  cat <<'EOF'
set -eu

if [ -z "$(which gpg)" ]; then
  echo 'gpg is not installed, please install it on the remote host' >&2
  exit 1
fi

if [ -z "$(which reprepro)" ]; then
  echo 'reprepro is not installed, please install it on the remote host' >&2
  exit 1
fi

if [ -z "$(which uudecode)" ]; then
  echo 'uudecode is not installed, please install it on the remote host' >&2
  exit 1
fi

archive_dir=$1
target_codename=$2

mkdir -p "${archive_dir}/conf"

# "SignWith: yes" here presumes that user has GPG set up so that releases
# can be signed without prompting.
cat <<REMOTE_EOF > "${archive_dir}/conf/distributions"
Codename: ${target_codename}
Architectures: amd64 i386
Components: main
SignWith: yes
REMOTE_EOF
EOF

  # debs archive
  cat <<'EOF'
rm -rf "${archive_dir}/incoming"
mkdir -p "${archive_dir}/incoming"
cd "${archive_dir}/incoming"
set +eu
EOF
  (
    cd "$debsdir"
    find . -maxdepth 1 \
      ! '(' -type d -or -name Makefile -or -name .gitignore ')' -print0 \
      | sed -z 's|^./||' \
      | grep -z "$pkgregex" \
      | xargs -0 shar --no-check-existing --quiet --quiet-unshar --uuencode \
      | grep -Fvx 'exit 0'
  )

  # footer
  cat <<'EOF'
set -eu

# run reprepro now
cd "${archive_dir}"
for changefile in incoming/*.changes; do
  test -e "$changefile" || continue
  reprepro --basedir "$archive_dir" --ignore=wrongdistribution include \
    "$target_codename" "$changefile"
done
EOF
}

remote_script \
  | ssh -l "$archive_login" "$archive_server" sh /dev/stdin "$archive_dir" \
      "$target_codename"
